<?
/* 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
    Author: Ehsan Nourbakhsh <ehsaan@gmail.com>
    Date: 2011/10/27
*/
session_name("sharedride");
session_start();

if (!isset($_SESSION['validated']) || $_SESSION['validated']!=1)
{
	header('location: login.php');
	die("auth error");
}
$newLogin=1;
if (!isset($_SESSION['dbLogin']))
{
	$_SESSION['dbLogin']=1;
	$newLogin=1;
}

$head="	
<html> 
<head> 
    <title>Erman Shared Ride Utility</title>
    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />
    <meta http-equiv=\"Content-Language\" Content=\"en\">
    <script type=\"text/javascript\" src=\"lib/jquery-1.6.4.min.js\"></script> 
    <script type=\"text/javascript\" src=\"lib/jquery.form.js\"></script> 
    <script type=\"text/javascript\" src=\"lib/jquery-ui-1.8.16.custom/js/jquery-ui-1.8.16.custom.min.js\"></script>
    <script type=\"text/javascript\" src=\"lib/jquery-ui-timepicker-addon.js\"></script>
    <link rel=\"stylesheet\" media=\"all\" type=\"text/css\" href=\"lib/jquery-ui-1.8.16.custom/css/ui-lightness/jquery-ui-1.8.16.custom.css\" />

 
    <script type=\"text/javascript\"> 
messageDelay=2000;
cnt=0;
function submitFinished( response ) {
  $('#sendingMessage').fadeOut();
  switch ( response  ) {
	case \"success-profile\":
		$('#content').load('index.php?operation=profile&ajax', init);
		break;
 	case \"success\":
		$('#successMessage').fadeIn().delay(messageDelay).fadeOut();
		$('#senderName').val( \"\" );
		$('#senderEmail').val( \"\" );
		$('#message').val( \"\" );
		$('#content').delay(messageDelay+500).fadeTo( 'slow', 1 );
		$('#content').load('index.php?operation=listonly&ajax', init);
		break;
 	case \"success-comment\":
		$('#successMessage').fadeIn().delay(messageDelay).fadeOut();
		$('#senderName').val( \"\" );
		$('#senderEmail').val( \"\" );
		$('#message').val( \"\" );
		$('#content').delay(messageDelay+500).fadeTo( 'slow', 1 );
		$('#content').load('index.php?operation=comment&ajax', init);
		break;
	default:
		$('#failureMessage').fadeIn().delay(messageDelay).fadeOut();
		$('#returnMessage').delay(messageDelay).fadeIn().delay(messageDelay).fadeOut();
		$('#returnMessage').html('<p>'+response+'</p>');
		$('#content').delay(2*messageDelay).fadeTo( 'slow', 1 );
		$('#content').load('index.php?operation=listonly&ajax', init);
  }
}

function submitForm() {


  var contactForm = $(this);
 
  // Are all the fields filled in?
 
 
    $('#sendingMessage').fadeIn();
    contactForm.fadeOut();
 
    $.ajax( {
     url: contactForm.attr( 'action' ) + \"?ajax=true\",
      type: contactForm.attr( 'method' ),
      data: contactForm.serialize(),
      success: submitFinished
    } );
 
  // Prevent the default form submission occurring
  return false;
}
function initShowProfile()
{
$('a[href=\"#showProfile\"]').click(function(e) {
		$('#content').load('index.php?operation=profile&ajax=1', init);
		return false;
        //Cancel the link behavior
        e.preventDefault();
        //Get the A tag
        var id = $(this).attr('href');

        //Get the screen height and width
        var maskHeight = $(document).height();
        var maskWidth = $(window).width();
     
        //Set height and width to mask to fill up the whole screen
        $('#mask').css({'width':maskWidth,'height':maskHeight});

	//Set the popup window to center
	//Get the window height and width
        var winH = $(window).height();
        var winW = $(window).width();
	$('#mask').fadeIn();
        $('#showWindow').css('top',  winH/2-$('#showWindow').height()/2);
        $('#showWindow').css('left', winW/2-$('#showWindow').width()/2);
	$('#content').fadeTo( 'slow', .2 );
	$('#showWindow').fadeIn( 'slow', function() {
		$('#content').load('index.php?operation=profile&ajax=1', init);
		return false;
    	});
     
    //if close button is clicked
    $('.window .close').click(function (e) {
        //Cancel the link behavior
        e.preventDefault();
    	$('#content').fadeTo( 'slow', 1 );
    });     
    $('#mask').click(function () {
        $(this).hide();
        $('#showWindow').hide();
    	$('#content').fadeTo( 'slow', 1 );
    }); 
});
     
}
function init()
{
            // bind 'myForm' and provide a simple callback function 
            $('.seatselection').submit(submitForm); 
            $('.removeForm').submit(submitForm); 
            $('.cancelForm').submit(submitForm); 
	    $('.submitComment').submit(submitForm);
	    $('#offerForm').hide().submit( submitForm ).addClass( 'positioned' );

	    $('a[href=\"#showOfferForm\"]').click( function() {
		    $('#content').fadeTo( 'slow', .2 );
		    $('#offerForm').fadeIn( 'slow', function() {
		      $('#destination').focus();
		    } )
 
	         return false;
  	    } );
	    $('a[href=\"#toggleEmailOffer\"]').click( function() {
		$('#sendingMessage').fadeIn();
		$.get(\"index.php\",{operation:\"profile-change\",change:\"offer\",ajax:\"true\"},
      			submitFinished
    		);
 
  		// Prevent the default form submission occurring
  		return false;
	    });
	    $('a[href=\"#toggleEmailCancel\"]').click( function() {
		$('#sendingMessage').fadeIn();
		$.get(\"index.php\",{operation:\"profile-change\",change:\"cancel\",ajax:\"true\"},
      			submitFinished
    		);
 
  		// Prevent the default form submission occurring
  		return false;
	    });
	    $('a[href=\"#reload\"]').click( function() {
		 $('#content').load('index.php?operation=listonly&ajax', init);
	         return false;
	    } );
	$('#timeOffer').datetimepicker({
		showSecond: false,
		timeFormat: 'hh:mm:ss',
		dateFormat: 'yy-mm-dd',
		stepHour: 1,
		stepMinute: 15,
		minDate: 0, 
		maxDate: +7
	});
	var availableSources = [
			\"Rutford and Drive A\",
			\"Clubhouse of phase 8\",
			\"Chatham Court\"
		];
	var availableLocations = [
			\"Sara Bakery\",
			\"Walmart on Coit\",
			\"Target on Coit\",
			\"Airport\",
			\"IKEA\",
			\"Costco\",
			\"Downtown\"
		];
		$( '#offerDestination' ).autocomplete({
			source: availableLocations
		});
		$( '#offerSource' ).autocomplete({
			source: availableSources
		});
	  // When the Cancel button is clicked, close the form
	  $('#cancel').click( function() { 
		  $('#offerForm').fadeOut();
		  $('#content').fadeTo( 'slow', 1 );
	  } );  
 
  // When the Escape key is pressed, close the form
	  $('#offerForm').keydown( function( event ) {
	    if ( event.which == 27 ) {
	      $('#offerForm').fadeOut();
	      $('#content').fadeTo( 'slow', 1 );
	    }
	  } );
	initShowProfile();
} 
        // wait for the DOM to be loaded 
        $(document).ready(init); 
    </script> 
</head> 
<body>
<div id=\"sendingMessage\" class=\"statusMessage\"><p>Sending your message. Please wait...</p></div>
<div id=\"successMessage\" class=\"statusMessage\"><p>Operation was successful.</p></div>
<div id=\"failureMessage\" class=\"statusMessage\"><p>There was a problem. Please try again.</p></div>
<div id=\"returnMessage\" class=\"statusMessage\"><p>Unkonw problem.</p></div>
<div id=\"incompleteMessage\" class=\"statusMessage\"><p>Incomplete</p></div>
<div id=\"showWindow\" class=\"window\"></div>
<div id=\"mask\" ></div>
 

";
		$output="<link href=\"style.css\" type=\"text/css\" rel=\"stylesheet\" />\n";
        	$output.='<div class="container">Logged in as ' . $_SESSION['first'].' '.$_SESSION['last'].'('.$_SESSION['email'] . ") [<a href='logout.php' />logout</a>][<a href=\"#reload\">reload</a>][<a href=\"#showProfile\">profile</a>]\n";
	if ($_GET['operation']!="offer")
	{
		$output.="<a class=\"showOfferForm\" href=\"#showOfferForm\">Offer a ride</a><br/>";
	}
   
		$output.="<div id=\"content\">\n";

	$link = mysql_connect('dslabcomp', 'ehsansr','t3xAKeQaAdTq8z9X');
	if (!$link) {
    		die('Could not connect: ' . mysql_error());
	}
	mysql_select_db('ehsansr');
############## set USER ID or insert new user
	$query = "SELECT personid FROM persons WHERE email='".$_SESSION['email']."';";
	$result=mysql_query($query) or die (mysql_error());;
	$row=mysql_fetch_row($result);
	if (!$row)
	{
		$query = "INSERT INTO persons(name, email) VALUES ('".$_SESSION['first']." ".$_SESSION['last']."','".$_SESSION['email']."');";
		$result=mysql_query($query) or die (mysql_error());;
		$userid=mysql_insert_id();
	}
	else
	{
		$userid=$row[0];
	}

	if ($newLogin==1)
	{
		$query = "UPDATE persons SET lastLogin=NOW() WHERE `personid`=".$userid.";";
		$result=mysql_query($query) or die (mysql_error());;

	}
################
	if (!isset($_GET['ajax']))
	{	
		echo $head.$output;
	}
	switch($_GET['operation'])
	{
		case 'add':
			include('add.php');	
			break;
		case 'remove':
			include('remove.php');
			break;
		case 'delete':
			include('delete.php');	
			break;
		case 'listonly':
			include('list.php');
			break;
		case 'comments':
			include('comments.php');
			break;
		case 'comment-submit':
			include('comment-submit.php');
			break;
		case 'profile':
			include('profile.php');
			break;
		case 'profile-change':
			include('profile-change.php');
			break;
		case 'offer-add':
			include('offer-do.php');
		default:
			if (!isset($_GET['ajax']))
			{
				include('list.php');	
			}
			break;
	}
	$output="</div>\n";
	if ($_GET['operation']!="offer")
	{
		$output.="<a class=\"showOfferForm\" href=\"#showOfferForm\">Offer a ride</a><br/>
<div id=\"iofferform\"><form method=\"GET\" id=\"offerForm\" action=\"index.php\">
		<input type=\"hidden\" name=\"operation\" value=\"offer-add\" />
		From: <input id=\"offerSource\" type=\"text\" id=\"source\" name=\"source\" />
		Destination:<input id=\"offerDestination\" type=\"text\" id=\"destination\" name=\"destination\" />
		Time: <input id=\"timeOffer\" type=\"text\" name=\"time\" />
		Available seats (exluding yourself): <input type=\"text\" name=\"seats\" value=\"3\" />
		<input type=\"submit\" value=\"Add\" />
		<input type=\"button\" id=\"cancel\" name=\"cancel\" value=\"Cancel\" />
	</form></div>";

	}
	$output.="<img class=\"bgimg\"src=\"images/10.jpg\" />";
	$output.='<a rel="license" href="http://www.gnu.org/licenses/gpl.txt"><img alt="GNU Public License v3.0" style="border-width:0" src="images/gplv3-88x31.png" /></a><br />by <a href="http://www.utdallas.edu/~ehsaan/">Ehsan Nourbakhsh</a> </a>';
#/<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.';

	$output.=" </div>\n</body>\n</html>\n";
	if (!isset($_GET['ajax'])){echo $output;}
?>
